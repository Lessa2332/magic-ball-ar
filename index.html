<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindAR Magic Orb of Prophecy</title>
    <script src="https://cdn.jsdelivr.net/npm/mindar-image-three@1.0.0/dist/mindar-image-three.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script> <!-- Для сумісності, але ми не використовуємо GLB -->
    <style>
        /* Вбудований style.css */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Arial', sans-serif;
            color: #fff;
        }
        .prophecy {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            z-index: 100;
            font-size: 18px;
            max-width: 80%;
            animation: fadeInOut 4s ease-in-out;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
        .instructions {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 50;
        }
        #ar-root {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div class="instructions">
        <p>Відскануй зображення-ціль (чорний квадрат з білим колом). Доторкнись до кулі для пророцтва!</p>
    </div>
    <div id="ar-root"></div>

    <script>
        // Вбудований magic-orb.ts (як JS, без TypeScript компіляції)
        // === createMagicOrb функція ===
        function createMagicOrb(scene) {
            const group = new THREE.Group();

            // 1. Сфера (геометрія)
            const sphereGeo = new THREE.SphereGeometry(0.5, 64, 64);
            
            // 2. Шейдер: магічний градієнт + пульсація
            const orbMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    time: { value: 0 },
                    glowColor: { value: new THREE.Color(0x00ffff) },
                    pulse: { value: 1.0 }
                },
                vertexShader: `
                    varying vec3 vNormal;
                    varying vec3 vPosition;
                    void main() {
                        vNormal = normalize(normalMatrix * normal);
                        vPosition = position;
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform float time;
                    uniform vec3 glowColor;
                    uniform float pulse;
                    varying vec3 vNormal;
                    varying vec3 vPosition;
                    
                    void main() {
                        float fresnel = pow(1.0 - dot(vNormal, vec3(0,0,1)), 2.0);
                        float wave = sin(time * 3.0 + vPosition.y * 10.0) * 0.5 + 0.5;
                        vec3 color = mix(vec3(0.1, 0.0, 0.3), glowColor, wave * fresnel * pulse);
                        gl_FragColor = vec4(color, 0.9);
                    }
                `,
                transparent: true,
                side: THREE.DoubleSide
            });

            const orb = new THREE.Mesh(sphereGeo, orbMaterial);
            group.add(orb);

            // 3. Внутрішнє світло
            const innerLight = new THREE.PointLight(0x00ffff, 2, 2);
            innerLight.position.set(0, 0, 0);
            group.add(innerLight);

            // 4. Частинки (магічний дим)
            const particlesGeo = new THREE.BufferGeometry();
            const count = 300;
            const positions = new Float32Array(count * 3);
            const velocities = new Float32Array(count * 3);

            for (let i = 0; i < count * 3; i += 3) {
                positions[i] = (Math.random() - 0.5) * 1.2;
                positions[i+1] = (Math.random() - 0.5) * 1.2;
                positions[i+2] = (Math.random() - 0.5) * 1.2;

                velocities[i] = (Math.random() - 0.5) * 0.02;
                velocities[i+1] = (Math.random() - 0.5) * 0.02;
                velocities[i+2] = (Math.random() - 0.5) * 0.02;
            }

            particlesGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            particlesGeo.setAttribute('velocity', new THREE.BufferAttribute(velocities, 3));

            const particlesMat = new THREE.PointsMaterial({
                color: 0x88ffff,
                size: 0.05,
                transparent: true,
                opacity: 0.6,
                blending: THREE.AdditiveBlending
            });

            const particles = new THREE.Points(particlesGeo, particlesMat);
            group.add(particles);

            // 5. Анімація
            const clock = new THREE.Clock();
            function animate() {
                const t = clock.getElapsedTime();
                orbMaterial.uniforms.time.value = t;
                orbMaterial.uniforms.pulse.value = 0.8 + Math.sin(t * 2) * 0.2;

                const pos = particlesGeo.attributes.position.array;
                const vel = particlesGeo.attributes.velocity.array;

                for (let i = 0; i < count * 3; i += 3) {
                    pos[i] += vel[i];
                    pos[i+1] += vel[i+1];
                    pos[i+2] += vel[i+2];

                    if (Math.abs(pos[i]) > 0.7) vel[i] *= -1;
                    if (Math.abs(pos[i+1]) > 0.7) vel[i+1] *= -1;
                    if (Math.abs(pos[i+2]) > 0.7) vel[i+2] *= -1;
                }
                particlesGeo.attributes.position.needsUpdate = true;

                requestAnimationFrame(animate);
            }
            animate();

            scene.add(group);
            return group;
        }

        // === Пророцтва ===
        const prophecies = [
            "Ти знайдеш скарб під ялинкою!",
            "Твоя мрія здійсниться до Різдва!",
            "Сьогодні ти отримаєш 5 у школі!",
            "Ти — майбутній президент України!",
            "Твій улюблений герой прийде в гості!"
        ];

        function showProphecy() {
            const text = prophecies[Math.floor(Math.random() * prophecies.length)];
            const div = document.createElement('div');
            div.innerHTML = `<h2>Пророцтво:</h2><p>${text}</p>`;
            div.className = 'prophecy';
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }

        // === MindAR Setup ===
        const startButton = document.createElement('button');
        startButton.textContent = 'Запустити AR';
        startButton.style.position = 'fixed';
        startButton.style.top = '50%';
        startButton.style.left = '50%';
        startButton.style.transform = 'translate(-50%, -50%)';
        startButton.style.zIndex = '1000';
        startButton.style.padding = '10px 20px';
        startButton.style.background = '#00ffff';
        startButton.style.border = 'none';
        startButton.style.borderRadius = '5px';
        startButton.style.cursor = 'pointer';
        document.body.appendChild(startButton);

        startButton.addEventListener('click', async () => {
            startButton.remove();

            // Замість targets.mind — використовуй data URL для простого маркера (якщо немає .mind, це placeholder)
            // Для реального: завантаж targets.mind і скомпілюй з target.jpg за допомогою mindar-image-compiler
            const mindarThree = new window.MINDAR.ImageThree({
                container: document.getElementById('ar-root'),
                imageTargetSrc: './targets.mind', // Заміни на реальний файл або скомпілюй
                maxTrack: 1,
                uiLoading: "no",
                uiScanning: "no",
                filterMinCF: 0.0001,
                filterBeta: 0.01
            });

            const { renderer, scene, camera } = mindarThree;
            const anchor = mindarThree.addAnchor(0);

            // Створити магічну кулю
            const orb = createMagicOrb(scene);
            anchor.group.add(orb);

            // Ітеракція: дотик
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();

            function onClick(event) {
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObject(orb, true);

                if (intersects.length > 0) {
                    showProphecy();
                }
            }
            window.addEventListener('click', onClick);

            await mindarThree.start();
            renderer.setAnimationLoop(() => {
                renderer.render(scene, camera);
            });
        });

        // PWA Manifest (для офлайн)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js'); // Додай service worker для кешу
        }
    </script>

    <!-- Вбудований README.ua.md як коментар -->
    <!--
    # Магічна Куля Пророцтв (MindAR + Three.js)

    ## Встановлення
    1. Скомпілюй targets.mind з target.jpg: npm install -g @mindar/image-compiler; mindar-image-compiler -i target.jpg -o targets.mind
    2. Відкрий index.html в браузері (Chrome/Safari).

    ## Файли
    - index.html: Головний файл
    - magic-orb.ts: Генерація кулі (вбудовано як JS)
    - targets.mind: Маркер (скомпілюй з target.jpg)
    - target.jpg: Чорний квадрат з білим колом (A5, 300 DPI)
    - style.css: Стилі (вбудовано)
    - PDF_A5.pdf: Для друку (див. нижче)

    ## PDF_A5.pdf вміст (згенеруй через print-to-PDF)
    [Image: target.jpg]
    QR: https://github.io/.../index.html
    Доторкнись до кулі!

    Розмір проєкту: <500 KB
    -->

</body>
</html>
