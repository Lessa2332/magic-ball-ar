<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Ball AR - –ü—Ä–æ—Ä–æ—Ü—Ç–≤–æ (A-Frame + MindAR)</title>
    
    <!-- Preload –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤ -->
    <link rel="preload" href="./targets.mind" as="fetch" crossorigin>
    <link rel="preload" href="magic.mp3" as="audio">
    
    <!-- –§—ñ–∫—Å favicon: inline SVG -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåü</text></svg>">
    
    <!-- A-Frame + MindAR CDN -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.3/dist/mindar-image.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.3/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        :root {
            --primary-glow: #00ffff;
            --secondary-glow: #0088ff;
            --transition-speed: 0.3s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #000428, #004e92);
            font-family: 'Arial', sans-serif;
            color: #fff;
            position: relative;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 20, 40, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 255, 255, 0.3);
            border-top: 3px solid var(--primary-glow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: var(--primary-glow);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* UI Components */
        .instructions {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            font-size: 14px;
            line-height: 1.4;
            z-index: 50;
            backdrop-filter: blur(10px);
            transition: opacity var(--transition-speed);
        }
        
        .status-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 50;
            transition: all var(--transition-speed);
        }
        
        .status-tracking { background: rgba(0, 255, 0, 0.2); border: 1px solid #00ff00; }
        .status-scanning { background: rgba(255, 255, 0, 0.2); border: 1px solid #ffff00; }
        .status-error { background: rgba(255, 0, 0, 0.2); border: 1px solid #ff0000; }
        
        .prophecy-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.95), rgba(0, 136, 255, 0.95));
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 100;
            font-size: 20px;
            max-width: 85%;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.5);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .prophecy-overlay.visible {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .prophecy-title {
            font-size: 24px;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .prophecy-text {
            font-size: 18px;
            line-height: 1.4;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .error-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            padding: 20px;
            text-align: center;
        }
        
        .error-overlay.visible {
            display: flex;
        }
        
        /* –ê–Ω—ñ–º–∞—Ü—ñ—ó */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 255, 0.5); }
            50% { box-shadow: 0 0 40px rgba(0, 255, 255, 0.8); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å */
        @media (max-width: 768px) {
            .instructions {
                font-size: 12px;
                padding: 12px;
            }
            
            .prophecy-overlay {
                padding: 20px;
                font-size: 18px;
            }
            
            .prophecy-title { font-size: 20px; }
            .prophecy-text { font-size: 16px; }
        }
        
        audio { display: none; }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="progressBar"></div>
        </div>
        <div id="loadingText">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è AR...</div>
    </div>

    <!-- UI Elements -->
    <div class="instructions">
        <p>üì± –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä (marker.png). –î–æ—Ç–æ—Ä–∫–Ω–∏—Å—å –¥–æ –º–∞–≥—ñ—á–Ω–æ—ó –∫—É–ª—ñ –¥–ª—è –ø—Ä–æ—Ä–æ—Ü—Ç–≤–∞!</p>
    </div>
    
    <div class="status-indicator status-scanning" id="statusIndicator">
        üîç –°–∫–∞–Ω—É–≤–∞–Ω–Ω—è...
    </div>

    <!-- Prophecy Overlay -->
    <div class="prophecy-overlay" id="prophecyOverlay">
        <div class="prophecy-title">üåü –ú–∞–≥—ñ—á–Ω–µ –ü—Ä–æ—Ä–æ—Ü—Ç–≤–æ</div>
        <div class="prophecy-text" id="prophecyText"></div>
    </div>

    <!-- Error Overlay -->
    <div class="error-overlay" id="errorOverlay">
        <h2>‚ùå –ü–æ–º–∏–ª–∫–∞ AR</h2>
        <p id="errorMessage">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ AR. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–æ–∑–≤—ñ–ª –∫–∞–º–µ—Ä–∏.</p>
        <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #00ffff; border: none; border-radius: 5px; cursor: pointer;">
            –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É
        </button>
    </div>

    <!-- Audio Elements -->
    <audio id="magic-sound" src="magic.mp3" preload="auto"></audio>
    <audio id="appear-sound" src="appear.mp3" preload="auto"></audio>

    <!-- A-Frame Scene -->
    <a-scene 
        mindar-image="imageTargetSrc: ./targets.mind; maxTrack: 1; filterMinCF: 0.0001; filterBeta: 0.01; uiScanning: #no-ui; uiLoading: #no-ui"
        color-space="sRGB"
        renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        embedded
        a-assets-timeout="15000">
        
        <!-- –ö–∞–º–µ—Ä–∞ -->
        <a-camera position="0 0 0" look-controls="enabled: false" wasd-controls="enabled: false"></a-camera>

        <!-- –¶—ñ–ª—å: mindar-image-target -->
        <a-entity mindar-image-target="targetIndex: 0">
            <!-- –ú–∞–≥—ñ—á–Ω–∞ –∫—É–ª—è -->
            <a-entity id="magic-orb" position="0 0 0" scale="0.5 0.5 0.5">
                <!-- –û—Å–Ω–æ–≤–Ω–∞ —Å—Ñ–µ—Ä–∞ -->
                <a-sphere 
                    geometry="primitive: sphere; radius: 1; segmentsWidth: 64; segmentsHeight: 64"
                    material="color: #001133; emissive: #00ffff; emissiveIntensity: 0.5; transparent: true; opacity: 0.9; shader: standard"
                    animation__pulse="property: material.emissiveIntensity; from: 0.5; to: 1.0; dir: alternate; dur: 2000; easing: easeInOutSine; loop: true"
                    animation__rotate="property: rotation; to: 0 360 0; dur: 15000; easing: linear; loop: true">
                </a-sphere>

                <!-- –î–æ–¥–∞—Ç–∫–æ–≤–∏–π glow –µ—Ñ–µ–∫—Ç -->
                <a-sphere
                    geometry="primitive: sphere; radius: 1.1; segmentsWidth: 32; segmentsHeight: 32"
                    material="color: #00ffff; transparent: true; opacity: 0.1; shader: flat; side: back"
                    animation__pulse-opacity="property: material.opacity; from: 0.05; to: 0.15; dur: 3000; easing: easeInOutSine; loop: true">
                </a-sphere>

                <!-- –í–Ω—É—Ç—Ä—ñ—à–Ω—î —Å–≤—ñ—Ç–ª–æ -->
                <a-point-light 
                    position="0 0 0" 
                    color="#00ffff" 
                    intensity="2" 
                    distance="3"
                    animation="property: intensity; from: 1.5; to: 2.5; dir: alternate; dur: 2000; easing: easeInOutSine; loop: true">
                </a-point-light>

                <!-- –ß–∞—Å—Ç–∏–Ω–∫–∏ -->
                <a-entity 
                    particle-system="preset: dust; color: #88ffff, #00ffff, #ffffff; particleCount: 200; velocityValue: 0.03; velocitySpread: 0.05; accelerationValue: 0; accelerationSpread: 0.01; startSize: 0.03; endSize: 0.01; opacity: 0.4; blending: additive; texture: default"
                    position="0 0 0"
                    animation__particles="property: particle-system.velocityValue; from: 0.02; to: 0.04; dir: alternate; dur: 4000; loop: true">
                </a-entity>
            </a-entity>

            <!-- –ö–ª—ñ–∫-—ñ–Ω—Ç–µ—Ä–∞–∫—Ü—ñ—è -->
            <a-entity 
                cursor="rayOrigin: mouse; fuse: false"
                raycaster="objects: #magic-orb; far: 100"
                event-set__enter="_event: mouseenter; _target: #magic-orb; scale: 1.1 1.1 1.1"
                event-set__leave="_event: mouseleave; _target: #magic-orb; scale: 1 1 1"
                geometry="primitive: ring; radiusInner: 0.015; radiusOuter: 0.025"
                material="color: #00ffff; shader: flat; transparent: true; opacity: 0.8"
                position="0 0 -1"
                animation="property: position; to: 0 0.1 0; dur: 2000; dir: alternate; loop: true; easing: easeInOutSine">
            </a-entity>
        </a-entity>
    </a-scene>

    <script>
        class MagicBallAR {
            constructor() {
                this.scene = document.querySelector('a-scene');
                this.orb = document.querySelector('#magic-orb');
                this.loadingScreen = document.getElementById('loadingScreen');
                this.progressBar = document.getElementById('progressBar');
                this.loadingText = document.getElementById('loadingText');
                this.statusIndicator = document.getElementById('statusIndicator');
                this.prophecyOverlay = document.getElementById('prophecyOverlay');
                this.prophecyText = document.getElementById('prophecyText');
                this.errorOverlay = document.getElementById('errorOverlay');
                this.errorMessage = document.getElementById('errorMessage');
                
                this.isTracking = false;
                this.isLoaded = false;
                
                this.prophecies = [
                    "–¢–∏ –∑–Ω–∞–π–¥–µ—à —Å–∫–∞—Ä–± –ø—ñ–¥ —è–ª–∏–Ω–∫–æ—é! üéÅ",
                    "–¢–≤–æ—è –º—Ä—ñ—è –∑–¥—ñ–π—Å–Ω–∏—Ç—å—Å—è –¥–æ –†—ñ–∑–¥–≤–∞! ‚≠ê",
                    "–°—å–æ–≥–æ–¥–Ω—ñ —Ç–∏ –æ—Ç—Ä–∏–º–∞—î—à 5 —É —à–∫–æ–ª—ñ! üìö",
                    "–¢–∏ ‚Äî –º–∞–π–±—É—Ç–Ω—ñ–π –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç –£–∫—Ä–∞—ó–Ω–∏! üá∫üá¶",
                    "–¢–≤—ñ–π —É–ª—é–±–ª–µ–Ω–∏–π –≥–µ—Ä–æ–π –ø—Ä–∏–π–¥–µ –≤ –≥–æ—Å—Ç—ñ! ü¶∏",
                    "–¢–µ–±–µ —á–µ–∫–∞—î –≤–µ–ª–∏–∫–∞ –ø–æ–¥–æ—Ä–æ–∂! ‚úàÔ∏è",
                    "–ó–Ω–∞–π–¥–µ—à –Ω–æ–≤–æ–≥–æ –Ω–∞–π–∫—Ä–∞—â–æ–≥–æ –¥—Ä—É–≥–∞! üë´",
                    "–í—ñ–¥–∫—Ä–∏—î—à —É —Å–æ–±—ñ —Ç–∞–ª–∞–Ω—Ç! üé®",
                    "–ó—Ä–æ–±–∏—à –≤–∞–∂–ª–∏–≤–µ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è! üîç",
                    "–°—Ç–∞–Ω–µ—à –≥–µ—Ä–æ—î–º –¥–ª—è –∫–æ–≥–æ—Å—å! üèÜ"
                ];
                
                this.init();
            }
            
            async init() {
                try {
                    await this.setupEventListeners();
                    await this.setupAR();
                    this.setupPerformanceMonitoring();
                } catch (error) {
                    this.showError('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó: ' + error.message);
                }
            }
            
            async setupEventListeners() {
                // –ö–ª—ñ–∫ –Ω–∞ –∫—É–ª—é
                this.scene.addEventListener('click', (evt) => {
                    if (evt.detail.el === this.orb || evt.detail.target.closest('#magic-orb')) {
                        this.showProphecy();
                    }
                });
                
                // –ü–æ–¥—ñ—ó MindAR
                this.scene.addEventListener('mindarTargetFound', () => {
                    this.onTargetFound();
                });
                
                this.scene.addEventListener('mindarTargetLost', () => {
                    this.onTargetLost();
                });
                
                // –ü–æ–¥—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ü–µ–Ω–∏
                this.scene.addEventListener('loaded', () => {
                    this.onSceneLoaded();
                });
                
                // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
                window.addEventListener('error', (e) => {
                    console.error('Global error:', e.error);
                    this.showError('–°—Ç–∞–ª–∞—Å—è –Ω–µ—Å–ø–æ–¥—ñ–≤–∞–Ω–∞ –ø–æ–º–∏–ª–∫–∞');
                });
            }
            
            async setupAR() {
                try {
                    // –°–∏–º—É–ª—è—Ü—ñ—è –ø—Ä–æ–≥—Ä–µ—Å—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
                    this.simulateLoadingProgress();
                    
                    const mindar = this.scene.components['mindar-image'];
                    if (!mindar) {
                        throw new Error('MindAR –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                    }
                    
                    await mindar.start();
                    this.isLoaded = true;
                    
                } catch (error) {
                    console.error('AR setup error:', error);
                    throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ AR: ' + error.message);
                }
            }
            
            simulateLoadingProgress() {
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress >= 90) {
                        progress = 90;
                        clearInterval(interval);
                    }
                    this.updateLoadingProgress(progress);
                }, 200);
            }
            
            updateLoadingProgress(progress) {
                this.progressBar.style.width = progress + '%';
                this.loadingText.textContent = `–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è AR... ${Math.round(progress)}%`;
            }
            
            onSceneLoaded() {
                setTimeout(() => {
                    this.loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        this.loadingScreen.style.display = 'none';
                    }, 500);
                }, 1000);
            }
            
            onTargetFound() {
                if (!this.isTracking) {
                    this.isTracking = true;
                    this.statusIndicator.className = 'status-indicator status-tracking';
                    this.statusIndicator.innerHTML = '‚úÖ –ú–∞—Ä–∫–µ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ!';
                    
                    // –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–≤—É–∫—É –ø–æ—è–≤–∏
                    this.playSound('appear-sound');
                }
            }
            
            onTargetLost() {
                this.isTracking = false;
                this.statusIndicator.className = 'status-indicator status-scanning';
                this.statusIndicator.innerHTML = 'üîç –°–∫–∞–Ω—É–≤–∞–Ω–Ω—è...';
            }
            
            showProphecy() {
                if (!this.isTracking) return;
                
                const sound = document.getElementById('magic-sound');
                sound.currentTime = 0;
                sound.play().catch(e => console.log('–ó–≤—É–∫ –Ω–µ –≤—ñ–¥—Ç–≤–æ—Ä–∏–≤—Å—è:', e));
                
                const text = this.prophecies[Math.floor(Math.random() * this.prophecies.length)];
                this.prophecyText.textContent = text;
                this.prophecyOverlay.classList.add('visible');
                
                // –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ (–ø—Ä–∏–∫–ª–∞–¥)
                this.trackEvent('prophecy_shown', { prophecy: text });
                
                setTimeout(() => {
                    this.prophecyOverlay.classList.remove('visible');
                }, 4000);
            }
            
            playSound(soundId) {
                const sound = document.getElementById(soundId);
                if (sound) {
                    sound.currentTime = 0;
                    sound.play().catch(e => console.log('Sound error:', e));
                }
            }
            
            showError(message) {
                this.errorMessage.textContent = message;
                this.errorOverlay.classList.add('visible');
                this.loadingScreen.style.display = 'none';
                
                this.trackEvent('ar_error', { error: message });
            }
            
            setupPerformanceMonitoring() {
                // –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ FPS
                let frameCount = 0;
                let lastTime = performance.now();
                
                const checkFPS = () => {
                    frameCount++;
                    const currentTime = performance.now();
                    if (currentTime >= lastTime + 1000) {
                        const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                        if (fps < 30) {
                            console.warn('Low FPS:', fps);
                            this.reduceEffects();
                        }
                        frameCount = 0;
                        lastTime = currentTime;
                    }
                    requestAnimationFrame(checkFPS);
                };
                checkFPS();
            }
            
            reduceEffects() {
                // –ó–º–µ–Ω—à–µ–Ω–Ω—è –µ—Ñ–µ–∫—Ç—ñ–≤ –ø—Ä–∏ –Ω–∏–∑—å–∫–æ–º—É FPS
                const particles = document.querySelector('[particle-system]');
                if (particles) {
                    particles.setAttribute('particle-system', 'particleCount', 100);
                }
            }
            
            trackEvent(eventName, params = {}) {
                // –ü—Ä–∏–∫–ª–∞–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏
                if (typeof gtag !== 'undefined') {
                    gtag('event', eventName, params);
                }
                console.log('Event:', eventName, params);
            }
        }
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–æ–¥–∞—Ç–∫—É
        document.addEventListener('DOMContentLoaded', () => {
            window.magicBallAR = new MagicBallAR();
        });
        
        // Service Worker –¥–ª—è –æ—Ñ–ª–∞–π–Ω —Ä–æ–±–æ—Ç–∏ (–æ–ø—Ü—ñ–π–Ω–æ)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW registration failed'));
        }
    </script>
</body>
</html>
